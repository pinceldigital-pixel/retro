<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Radio PWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        .font-montserrat {
            font-family: 'Montserrat', sans-serif;
        }

        /* --- Animación de pulso para ON AIR --- */
        .on-air-pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(234, 88, 12, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); }
        }
        
        /* --- Estilos del Dial Recto --- */
        #dial-track {
            transition: transform 1s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
    </style>
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
</head>
<body class="text-white flex flex-col items-center justify-center min-h-screen p-4 overflow-hidden">

    <div class="w-full max-w-sm mx-auto bg-gray-900 rounded-3xl p-6 flex flex-col justify-between" style="height: 90vh; max-height: 800px;">
        
        <!-- HEADER: ON AIR Y TEMPORIZADOR -->
        <header class="flex justify-between items-center">
            <div id="air-status-container" class="flex items-center space-x-2">
                <div id="air-status-dot" class="w-3 h-3 rounded-full bg-gray-600"></div>
                <span id="air-status-text" class="text-sm font-semibold text-gray-400 tracking-widest">OFF AIR</span>
            </div>
            <button id="sleep-timer-btn" class="text-gray-400 hover:text-white transition-colors" style="color:#9ca3af;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </header>

        <!-- DISPLAY PRINCIPAL Y DIAL -->
        <main class="flex-grow flex flex-col items-center justify-center text-center -mt-4">
            <h1 id="station-freq" class="font-montserrat text-8xl font-bold tracking-tighter">--.-</h1>
            <p id="station-name" class="text-xl font-medium text-gray-300 mt-2 tracking-wider">Selecciona una estación</p>
            
            <!-- DIAL DE RADIO RECTO -->
            <div class="w-full h-24 mt-6 mb-8 relative flex justify-center items-center">
                <!-- Ventana del dial -->
                <div id="dial-container" class="w-11/12 h-12 relative overflow-hidden">
                    <!-- Riel de Frecuencias (el que se mueve) -->
                    <div id="dial-track" class="absolute top-0 left-0 h-full flex items-center whitespace-nowrap">
                        <!-- Marcas y números generados por JS -->
                    </div>
                </div>
                
                <!-- Aguja Naranja (Fija) -->
                <div class="absolute w-0.5 h-14 bg-orange-500 rounded-full shadow-[0_0_8px_theme(colors.orange.500)]"></div>
            </div>
        </main>
        
        <!-- CONTROLES -->
        <footer class="flex items-center justify-around w-full">
            <button id="prev-btn" class="p-3 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8.445 14.832A1 1 0 0010 14.03V5.969a1 1 0 00-1.555-.832L4.12 9.168a1 1 0 000 1.664l4.325 4.001z" /><path d="M14.445 14.832A1 1 0 0016 14.03V5.969a1 1 0 00-1.555-.832L10.12 9.168a1 1 0 000 1.664l4.325 4.001z" />
                </svg>
            </button>
            <button id="play-pause-btn" class="bg-transparent border-2 border-gray-600 rounded-full p-5 shadow-lg transform hover:scale-105 hover:border-orange-500 transition-all">
                <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M6.3 5.1A1 1 0 0 0 5 6v8a1 1 0 0 0 1.3.9l6-4a1 1 0 0 0 0-1.8l-6-4z" />
                </svg>
                <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 hidden" fill="currentColor" viewBox="0 0 20 20">
                     <path d="M5 6a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H5zm6 0a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1h-2z"/>
                </svg>
            </button>
            <button id="next-btn" class="p-3 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5.555 5.168A1 1 0 004 5.969v8.062a1 1 0 001.555.832L10.88 10.832a1 1 0 000-1.664L5.555 5.168z" /><path d="M11.555 5.168A1 1 0 0010 5.969v8.062a1 1 0 001.555.832L16.88 10.832a1 1 0 000-1.664l-5.325-4.001z" />
                </svg>
            </button>
        </footer>
    </div>
    
    <audio id="radio-player" crossorigin="anonymous"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Service Worker y PWA ---
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('Service Worker registrado con éxito:', registration))
                    .catch(error => console.log('Error en el registro del Service Worker:', error));
            }

            // --- Elementos del DOM ---
            const player = document.getElementById('radio-player');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const stationFreqEl = document.getElementById('station-freq');
            const stationNameEl = document.getElementById('station-name');
            const airStatusDot = document.getElementById('air-status-dot');
            const airStatusText = document.getElementById('air-status-text');
            const sleepTimerBtn = document.getElementById('sleep-timer-btn');
            const dialTrack = document.getElementById('dial-track');
            const dialContainer = document.getElementById('dial-container');

            // --- Datos de las estaciones ---
            const stations = [
                { name: 'Now 97.9', freq: '97.9', url: 'https://ipanel.instream.audio:7002/stream' },
                { name: 'Blue 100.7', freq: '100.7', url: 'https://27693.live.streamtheworld.com/BLUE_FM_100_7AAC.aac' },
                { name: 'Aspen 102.3', freq: '102.3', url: 'https://playerservices.streamtheworld.com/api/livestream-redirect/ASPEN.mp3' },
                { name: 'LN+ 104.9', freq: '104.9', url: 'https://stream.radio.co/s2ed3bec0a/listen' }
            ];
            
            // --- Estado de la aplicación ---
            let currentStationIndex = 0;
            let isPlaying = false;
            let sleepTimerId = null;

            // --- Funciones del Dial ---
            function generateDialMarks() {
                const minFreq = 87;
                const maxFreq = 109;
                const spacing = 12; // px entre cada marca de 0.1 MHz

                let content = '';
                for (let i = minFreq * 10; i <= maxFreq * 10; i++) {
                    const isMajorTick = (i % 10 === 0);
                    const isMediumTick = (i % 5 === 0);
                    
                    content += `<div class="relative flex flex-col items-center h-full justify-start pt-1" style="width: ${spacing}px;">`;
                    if (isMajorTick) {
                        content += `<span class="absolute top-6 text-sm font-semibold text-gray-200">${i / 10}</span>`;
                        content += `<div class="w-0.5 h-4 bg-gray-300"></div>`;
                    } else if (isMediumTick) {
                        content += `<div class="w-px h-3 bg-gray-400"></div>`;
                    } else {
                        content += `<div class="w-px h-2 bg-gray-500"></div>`;
                    }
                    content += `</div>`;
                }
                dialTrack.innerHTML = content;
            }

            function updateDial(frequency) {
                const freq = parseFloat(frequency);
                const minFreq = 87;
                const spacing = 12; // Debe ser el mismo que en generateDialMarks

                const positionInTrack = (freq - minFreq) * 10 * spacing;
                const containerCenter = dialContainer.offsetWidth / 2;
                const translationX = -positionInTrack + containerCenter;

                dialTrack.style.transform = `translateX(${translationX}px)`;
            }

            // --- Funciones de control ---
            function loadStation(index) {
                const station = stations[index];
                stationFreqEl.textContent = station.freq;
                stationNameEl.textContent = station.name;
                player.src = station.url;
                updateDial(station.freq);
                updateMediaSession();
            }

            function playStation() {
                player.play().then(() => {
                    isPlaying = true;
                    updateUIOnPlay();
                }).catch(error => {
                    console.error("Error al reproducir:", error);
                    isPlaying = false;
                    updateUIOnPause();
                });
            }

            function pauseStation() {
                player.pause();
                isPlaying = false;
                updateUIOnPause();
            }

            // --- Actualizaciones de UI ---
            function updateUIOnPlay() {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                airStatusDot.classList.remove('bg-gray-600');
                airStatusDot.classList.add('bg-orange-500', 'on-air-pulse');
                airStatusText.textContent = 'ON AIR';
                airStatusText.classList.remove('text-gray-400');
                airStatusText.classList.add('text-white');
                playPauseBtn.classList.add('border-orange-500');
            }

            function updateUIOnPause() {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                airStatusDot.classList.add('bg-gray-600');
                airStatusDot.classList.remove('bg-orange-500', 'on-air-pulse');
                airStatusText.textContent = 'OFF AIR';
                airStatusText.classList.add('text-gray-400');
                airStatusText.classList.remove('text-white');
                playPauseBtn.classList.remove('border-orange-500');
            }

            // --- Event Listeners ---
            playPauseBtn.addEventListener('click', () => {
                if (isPlaying) {
                    pauseStation();
                } else {
                    playStation();
                }
            });

            nextBtn.addEventListener('click', () => {
                currentStationIndex = (currentStationIndex + 1) % stations.length;
                loadStation(currentStationIndex);
                if(isPlaying) playStation();
            });

            prevBtn.addEventListener('click', () => {
                currentStationIndex = (currentStationIndex - 1 + stations.length) % stations.length;
                loadStation(currentStationIndex);
                if(isPlaying) playStation();
            });
            
            sleepTimerBtn.addEventListener('click', () => {
                // Si el temporizador ya está activo, lo cancelamos.
                if (sleepTimerId) {
                    clearTimeout(sleepTimerId);
                    sleepTimerId = null;
                    // La luna vuelve a su color gris original.
                    sleepTimerBtn.classList.remove('text-orange-500');
                    sleepTimerBtn.classList.add('text-gray-400');
                } else {
                    // Si no hay temporizador, activamos uno nuevo.
                    // La luna se vuelve naranja para indicar que está activo.
                    sleepTimerBtn.style.color = '#f97316';  // orange-500
                    
                    // Configuramos el temporizador para 30 minutos.
                    sleepTimerId = setTimeout(() => {
                        pauseStation(); // Detiene la música.
                        sleepTimerId = null; // Reinicia el estado del temporizador.
                        // La luna vuelve a su color original una vez cumplido el tiempo.
                        sleepTimerBtn.style.color = '#9ca3af';  // gray-400
                    }, 30 * 60 * 1000); // 30 minutos en milisegundos
                }
            });

            // --- Media Session API ---
            function updateMediaSession() {
                if ('mediaSession' in navigator) {
                    const station = stations[currentStationIndex];
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: station.freq,
                        artist: station.name,
                        album: 'Radio PWA',
                        artwork: [
                            { src: 'icon-192.png', sizes: '192x192', type: 'image/png' },
                            { src: 'icon-512.png', sizes: '512x512', type: 'image/png' },
                        ]
                    });
                }
            }
            
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', playStation);
                navigator.mediaSession.setActionHandler('pause', pauseStation);
                navigator.mediaSession.setActionHandler('previoustrack', () => prevBtn.click());
                navigator.mediaSession.setActionHandler('nexttrack', () => nextBtn.click());
            }

            // --- Inicialización ---
            generateDialMarks();
            loadStation(currentStationIndex);
        });
    </script>

<script>
  // Prompt PWA install if supported (no UI changes).
  window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); window.__deferredPrompt = e; });
  // If launched in browser, try requestFullscreen on first user interaction.
  document.addEventListener('click', () => {
    const docEl = document.documentElement;
    if (!document.fullscreenElement && docEl.requestFullscreen) {
      // Best-effort; browsers block if not allowed. No UI change if it fails.
      docEl.requestFullscreen().catch(()=>{});
    }
  }, { once: true });
</script>

</body>
</html>

