<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Radio PWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@300;400;500&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #111827; /* gray-900 */
        }
        
        .font-montserrat {
            font-family: 'Montserrat', sans-serif;
        }

        /* --- Animación de pulso para ON AIR --- */
        .on-air-pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(234, 88, 12, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(234, 88, 12, 0);
            }
        }
    </style>

<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-title" content="Radio PWA">

</head>
<body class="text-white flex flex-col items-center justify-center min-h-screen p-4 overflow-hidden">

    <div class="w-full max-w-sm mx-auto bg-gray-900 rounded-3xl p-6 flex flex-col justify-between" style="height: 90vh; max-height: 800px;">
        
        <!-- HEADER: ON AIR Y TEMPORIZADOR -->
        <header class="flex justify-between items-center">
            <div id="air-status-container" class="flex items-center space-x-2">
                <div id="air-status-dot" class="w-3 h-3 rounded-full bg-gray-600"></div>
                <span id="air-status-text" class="text-sm font-semibold text-gray-400 tracking-widest">OFF AIR</span>
            </div>
            <button id="sleep-timer-btn" class="text-gray-400 hover:text-white transition-colors">
                <!-- Icono de Luna (Temporizador) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </header>

        <!-- DISPLAY PRINCIPAL Y VISUALIZADOR -->
        <main class="flex-grow flex flex-col items-center justify-center text-center -mt-4">
            <h1 id="station-freq" class="font-montserrat text-8xl font-bold tracking-tighter">--.-</h1>
            <p id="station-name" class="text-xl font-medium text-gray-300 mt-2 tracking-wider">Selecciona una estación</p>
            
            <!-- VISUALIZADOR DE ONDA -->
            <div class="h-24 w-full mt-6 mb-8">
                <canvas id="visualizer"></canvas>
            </div>
        </main>
        
        <!-- CONTROLES -->
        <footer class="flex items-center justify-around w-full bg-gray-800/40 rounded-full px-4 py-2 border border-gray-700 backdrop-blur-sm">
            <button id="prev-btn" class="p-3 text-gray-400 hover:text-white">
                <!-- Icono de Anterior -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8.445 14.832A1 1 0 0010 14.03V5.969a1 1 0 00-1.555-.832L4.12 9.168a1 1 0 000 1.664l4.325 4.001z" />
                    <path d="M14.445 14.832A1 1 0 0016 14.03V5.969a1 1 0 00-1.555-.832L10.12 9.168a1 1 0 000 1.664l4.325 4.001z" />
                </svg>
            </button>
            <button id="play-pause-btn" class="bg-transparent border-2 border-gray-600 rounded-full p-5 shadow-lg transform hover:scale-105 hover:border-orange-500 transition-all">
                <!-- Icono de Play -->
                <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M6.3 5.1A1 1 0 0 0 5 6v8a1 1 0 0 0 1.3.9l6-4a1 1 0 0 0 0-1.8l-6-4z" />
                </svg>
                <!-- Icono de Pausa -->
                <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 hidden" fill="currentColor" viewBox="0 0 20 20">
                     <path d="M5 6a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H5zm6 0a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1h-2z"/>
                </svg>
            </button>
            <button id="next-btn" class="p-3 text-gray-400 hover:text-white">
                <!-- Icono de Siguiente -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5.555 5.168A1 1 0 004 5.969v8.062a1 1 0 001.555.832L10.88 10.832a1 1 0 000-1.664L5.555 5.168z" />
                    <path d="M11.555 5.168A1 1 0 0010 5.969v8.062a1 1 0 001.555.832L16.88 10.832a1 1 0 000-1.664l-5.325-4.001z" />
                </svg>
            </button>
        </footer>
    </div>
    
    <audio id="radio-player" crossorigin="anonymous"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Service Worker y PWA ---
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('Service Worker registrado con éxito:', registration))
                    .catch(error => console.log('Error en el registro del Service Worker:', error));
            }

            // --- Elementos del DOM ---
            const player = document.getElementById('radio-player');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const stationFreqEl = document.getElementById('station-freq');
            const stationNameEl = document.getElementById('station-name');
            const airStatusDot = document.getElementById('air-status-dot');
            const airStatusText = document.getElementById('air-status-text');
            const sleepTimerBtn = document.getElementById('sleep-timer-btn');
            const visualizerCanvas = document.getElementById('visualizer');
            const ctx = visualizerCanvas.getContext('2d');

            // --- Datos de las estaciones ---
            const stations = [
                { name: 'Now 97.9', freq: '97.9', url: 'https://ipanel.instream.audio:7002/stream' },
                { name: 'Blue 100.7', freq: '100.7', url: 'https://27693.live.streamtheworld.com/BLUE_FM_100_7AAC.aac' },
                { name: 'Aspen 102.3', freq: '102.3', url: 'https://playerservices.streamtheworld.com/api/livestream-redirect/ASPEN.mp3' },
                { name: 'LN+ 104.9', freq: '104.9', url: 'https://stream.radio.co/s2ed3bec0a/listen' }
            ];
            
            // --- Estado de la aplicación ---
            let currentStationIndex = 0;
            let isPlaying = false;
            let audioContext, analyser, source, dataArray, bufferLength;
            let sleepTimerId = null;

            // --- Inicialización del Audio API ---
            function initAudioContext() {
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        analyser = audioContext.createAnalyser();
                        analyser.fftSize = 256; // Menos barras, más gruesas
                        source = audioContext.createMediaElementSource(player);
                        source.connect(analyser);
                        analyser.connect(audioContext.destination);
                        bufferLength = analyser.frequencyBinCount;
                        dataArray = new Uint8Array(bufferLength);
                    } catch (e) {
                        console.error("Web Audio API no es soportada en este navegador.", e);
                    }
                }
            }

            // --- Funciones de control ---
            function loadStation(index) {
                const station = stations[index];
                stationFreqEl.textContent = station.freq;
                stationNameEl.textContent = station.name;
                player.src = station.url;
                updateMediaSession();
            }

            function playStation() {
                initAudioContext();
                player.play().then(() => {
                    isPlaying = true;
                    updateUIOnPlay();
                    drawVisualizer();
                }).catch(error => {
                    console.error("Error al reproducir:", error);
                    isPlaying = false;
                    updateUIOnPause();
                });
            }

            function pauseStation() {
                player.pause();
                isPlaying = false;
                updateUIOnPause();
            }

            // --- Actualizaciones de UI ---
            function updateUIOnPlay() {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                airStatusDot.classList.remove('bg-gray-600');
                airStatusDot.classList.add('bg-orange-500', 'on-air-pulse');
                airStatusText.textContent = 'ON AIR';
                airStatusText.classList.remove('text-gray-400');
                airStatusText.classList.add('text-white');
                playPauseBtn.classList.add('border-orange-500');

            }

            function updateUIOnPause() {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                airStatusDot.classList.add('bg-gray-600');
                airStatusDot.classList.remove('bg-orange-500', 'on-air-pulse');
                airStatusText.textContent = 'OFF AIR';
                airStatusText.classList.add('text-gray-400');
                airStatusText.classList.remove('text-white');
                playPauseBtn.classList.remove('border-orange-500');
            }

            // --- Event Listeners ---
            playPauseBtn.addEventListener('click', () => {
                if (isPlaying) {
                    pauseStation();
                } else {
                    playStation();
                }
            });

            nextBtn.addEventListener('click', () => {
                currentStationIndex = (currentStationIndex + 1) % stations.length;
                loadStation(currentStationIndex);
                if(isPlaying) playStation();
            });

            prevBtn.addEventListener('click', () => {
                currentStationIndex = (currentStationIndex - 1 + stations.length) % stations.length;
                loadStation(currentStationIndex);
                if(isPlaying) playStation();
            });
            
            sleepTimerBtn.addEventListener('click', () => {
                if (sleepTimerId) {
                    clearTimeout(sleepTimerId);
                    sleepTimerId = null;
                    sleepTimerBtn.classList.remove('text-orange-500');
                    sleepTimerBtn.classList.add('text-gray-400');
                } else {
                    sleepTimerBtn.classList.remove('text-gray-400');
                    sleepTimerBtn.classList.add('text-orange-500');
                    sleepTimerId = setTimeout(() => {
                        pauseStation();
                        sleepTimerId = null;
                        sleepTimerBtn.classList.remove('text-orange-500');
                        sleepTimerBtn.classList.add('text-gray-400');
                    }, 30 * 60 * 1000); // 30 minutos
                }
            });

            // --- Media Session API ---
            function updateMediaSession() {
                if ('mediaSession' in navigator) {
                    const station = stations[currentStationIndex];
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: station.freq,
                        artist: station.name,
                        album: 'Radio PWA',
                        artwork: [
                            { src: 'icon-192.png', sizes: '192x192', type: 'image/png' },
                            { src: 'icon-512.png', sizes: '512x512', type: 'image/png' },
                        ]
                    });
                }
            }
            
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', playStation);
                navigator.mediaSession.setActionHandler('pause', pauseStation);
                navigator.mediaSession.setActionHandler('previoustrack', () => prevBtn.click());
                navigator.mediaSession.setActionHandler('nexttrack', () => nextBtn.click());
            }

            // --- Visualizer Drawing ---
            function drawVisualizer() {
                if (!isPlaying) {
                    ctx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
                    return;
                };
                requestAnimationFrame(drawVisualizer);

                analyser.getByteFrequencyData(dataArray);

                const { width, height } = visualizerCanvas;
                ctx.fillStyle = '#111827'; // bg-gray-900
                ctx.fillRect(0, 0, width, height);

                const barWidth = (width / bufferLength) * 2;
                let barHeight;
                let x = 0;
                
                ctx.fillStyle = '#ea580c'; // orange-600

                for (let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i] * 0.7; // Aumentar la altura
                    // Dibuja la barra desde la línea central hacia arriba
                    ctx.fillRect(x, (height - barHeight) / 2, barWidth, barHeight);
                    x += barWidth + 4; // Espacio entre barras
                }
            }
            
            // --- Ajustar canvas ---
            function resizeCanvas() {
                visualizerCanvas.width = visualizerCanvas.clientWidth * window.devicePixelRatio;
                visualizerCanvas.height = visualizerCanvas.clientHeight * window.devicePixelRatio;
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            // --- Cargar la primera estación al inicio ---
            loadStation(currentStationIndex);
        });
    </script>
</body>
</html>
