<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Radio Pro</title>
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <!-- Tailwind (para estilos rápidos) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height:100%; background:#000; }
    body { -webkit-tap-highlight-color: transparent; }
    .bg-grad { background: linear-gradient(180deg, #0a0a0a 0%, #000 100%); }
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(8px); }
    canvas { display:block; }
  </style>
</head>
<body class="bg-grad text-white antialiased h-full overflow-hidden">
  <main id="app" class="relative w-full h-full">
    <!-- Visualizador de onda en líneas (full screen) -->
    <canvas id="viz" class="absolute inset-0"></canvas>

    <!-- Pastilla superior con info (sin botones) -->
    <div class="absolute top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full glass border border-white/10 shadow-lg">
      <span id="air" class="inline-block w-2 h-2 rounded-full align-middle mr-2 bg-gray-500"></span>
      <span id="stationName" class="font-semibold">Now</span>
      <span class="mx-1">•</span>
      <span id="freq" class="text-white/70">97.9</span>
    </div>

    <!-- Hint sutil (no es botón, es texto) -->
    <div class="absolute bottom-6 left-1/2 -translate-x-1/2 text-center text-white/60 text-sm select-none">
      <p>Tocá en la pantalla para reproducir / pausar · Deslizá izquierda/derecha para cambiar</p>
    </div>
  </main>

  <audio id="player" crossorigin="anonymous"></audio>

  <script>
    // ------ Service Worker ------
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }

    // ------ Estaciones ------
    const stations = [
      { name: 'Now',   freq: '97.9', url: 'https://ipanel.instream.audio:7002/stream' },
      { name: 'Blue',  freq: '100.7', url: 'https://27693.live.streamtheworld.com/BLUE_FM_100_7AAC.aac' },
      { name: 'Aspen', freq: '102.3', url: 'https://playerservices.streamtheworld.com/api/livestream-redirect/ASPEN.mp3' },
      { name: 'LN+',   freq: '104.9', url: 'https://stream.radio.co/s2ed3bec0a/listen' }
    ];
    let idx = 0;
    let playing = false;

    // ------ DOM ------
    const player = document.getElementById('player');
    const nameEl = document.getElementById('stationName');
    const freqEl = document.getElementById('freq');
    const airDot = document.getElementById('air');
    const viz = document.getElementById('viz');
    const ctx = viz.getContext('2d');

    // ------ AudioContext + analyser ------
    let ac, analyser, src;
    function ensureAudio() {
      if (ac) return;
      ac = new (window.AudioContext || window.webkitAudioContext)();
      analyser = ac.createAnalyser();
      analyser.fftSize = 2048;
      src = ac.createMediaElementSource(player);
      src.connect(analyser);
      analyser.connect(ac.destination);
    }

    // ------ Visualizador de líneas ------
    function resize() {
      const dpr = window.devicePixelRatio || 1;
      viz.width = Math.floor(viz.clientWidth * dpr);
      viz.height = Math.floor(viz.clientHeight * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener('resize', resize);
    resize();

    function draw() {
      requestAnimationFrame(draw);
      ctx.clearRect(0, 0, viz.width, viz.height);
      const w = viz.clientWidth;
      const h = viz.clientHeight;

      // Fondo sutil
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, w, h);

      if (!analyser || !playing) return;

      // Time-domain data (onda)
      const buffer = new Uint8Array(analyser.fftSize);
      analyser.getByteTimeDomainData(buffer);

      // Dibujar varias "líneas" onduladas con offsets para efecto pro
      const layers = 3;
      for (let L = 0; L < layers; L++) {
        const offsetY = (L - 1) * 14; // separa capas
        ctx.beginPath();
        for (let i = 0; i < buffer.length; i++) {
          const x = (i / (buffer.length - 1)) * w;
          const v = (buffer[i] - 128) / 128; // -1..1
          const amp = (h * 0.15) * (1 + L*0.15);
          const y = h/2 + offsetY + v * amp;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        // trazo HSL naranja
        ctx.lineWidth = 2 - L*0.3;
        ctx.strokeStyle = `hsl(${30 + L*8}, 95%, ${55 - L*6}%)`;
        ctx.stroke();
      }
    }
    draw();

    // ------ Actualizar estación ------
    function setStation(i) {
      idx = (i + stations.length) % stations.length;
      const s = stations[idx];
      nameEl.textContent = s.name;
      freqEl.textContent = s.freq;
      if (player.src !== s.url) player.src = s.url;
      updateMediaSession();
      if (playing) player.play().catch(()=>{});
    }
    setStation(0);

    function setPlaying(p) {
      playing = p;
      airDot.className = 'inline-block w-2 h-2 rounded-full align-middle mr-2 ' + (playing ? 'bg-orange-500 shadow-[0_0_12px_rgba(249,115,22,0.8)]' : 'bg-gray-500');
      if (!ac) ensureAudio();
      if (ac.state === 'suspended') ac.resume();
      if (playing) player.play().catch(()=>{});
      else player.pause();
      navigator.mediaSession && (navigator.mediaSession.playbackState = playing ? 'playing' : 'paused');
    }

    // ------ Gestos (sin botones) ------
    let startX = null;
    window.addEventListener('pointerdown', (e) => {
      startX = e.clientX;
    }, {passive: true});
    window.addEventListener('pointerup', (e) => {
      if (startX === null) return;
      const dx = e.clientX - startX;
      if (Math.abs(dx) > 40) {
        // Swipe para cambiar
        setStation(idx + (dx < 0 ? 1 : -1));
      } else {
        // Tap para play/pause
        setPlaying(!playing);
      }
      startX = null;
    }, {passive: true});

    // ------ Media Session (barra de notificaciones) ------
    function updateMediaSession() {
      if (!('mediaSession' in navigator)) return;
      const s = stations[idx];
      navigator.mediaSession.metadata = new MediaMetadata({
        title: s.name + ' ' + s.freq,
        artist: 'Radio Pro',
        album: 'Live Stream',
        artwork: [
          { src: 'icons/icon-192.png', sizes: '192x192', type: 'image/png' },
          { src: 'icons/icon-512.png', sizes: '512x512', type: 'image/png' }
        ]
      });
    }
    updateMediaSession();

    if ('mediaSession' in navigator) {
      navigator.mediaSession.setActionHandler('play', () => setPlaying(true));
      navigator.mediaSession.setActionHandler('pause', () => setPlaying(false));
      navigator.mediaSession.setActionHandler('previoustrack', () => setStation(idx - 1));
      navigator.mediaSession.setActionHandler('nexttrack', () => setStation(idx + 1));
      // Seek en streams en vivo no aplica; lo omitimos para evitar UX rara.
    }
  </script>
</body>
</html>
